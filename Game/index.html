<!doctype html>
<meta charset="utf-8">
<title>Hello World</title>
<body>
    <script src="pixi.js/bin/pixi.js"></script>
    <script>

    var stage = new PIXI.Stage(0x000000);
    var renderer = PIXI.autoDetectRenderer(
      512, 512,
      {antialiasing: false, transparent: false, resolution: 1}
    );

    // Set stage to fill screen.
    // renderer.view.style.position = "absolute"
    // renderer.view.style.width = window.innerWidth + "px";
    // renderer.view.style.height = window.innerHeight + "px";
    // renderer.view.style.display = "block";

    document.body.appendChild(renderer.view);

    // Load tileset
    var loader = new PIXI.AssetLoader([
            "assets/tileset.png",
            "assets/dungeon.png",
            "assets/goblin.png"]);
    loader.onComplete = setup;
    loader.load();

    var hero, goblin, dungeon, state, message;
    // Function to load tileset and use sprite from it.
    function setup() {

      // Dungeon Texture
      var dungeonTexture = PIXI.TextureCache["assets/dungeon.png"];
      dungeon = new PIXI.Sprite(dungeonTexture);
      stage.addChild(dungeon);

      message = new PIXI.Text(
        "Hello Pixi!",
        {font: "32px sans-serif", fill: "white"}
      );

        message.position.set(54, 96);
        stage.addChild(message);


      //Create the `tileset` sprite from the texture
      var texture = PIXI.TextureCache["assets/tileset.png"];

      //Create a rectangle object that defines the position and
      //size of the sub-image you want to extract from the texture
      var heroFront = new PIXI.Rectangle(220, 128, 30, 30);
      var heroBack = new PIXI.Rectangle(220, 224, 30, 30);
      var heroRight = new PIXI.Rectangle(220, 192, 30, 30);
      var heroLeft = new PIXI.Rectangle(220, 160, 30, 30);
      //Tell the texture to use that rectangular section
      texture.setFrame(heroFront);

      //Create the sprite from the texture
      hero = new PIXI.Sprite(texture);


      // Goblin
      var goblinTexture = PIXI.TextureCache["assets/goblin.png"];
      var goblinFront = new PIXI.Rectangle(32, 0, 30, 30);

      goblinTexture.setFrame(goblinFront);

      goblin = new PIXI.Sprite(goblinTexture);

      goblin.x = 64;
      goblin.y = 64;

      stage.addChild(goblin);

      //Position the rocket sprite on the canvas
      hero.x = 32;
      hero.y = 32;

      // Handle Keyboard
      //Capture the keyboard arrow keys
      var left = keyboard(37),
      up = keyboard(38),
      right = keyboard(39),
      down = keyboard(40);

      //Left arrow key `press` method
      left.press = function() {
        //Change the hero's velocity when the key is pressed
        hero.vx = -3;
        hero.vy = 0;
        texture.setFrame(heroLeft);
      };

      //Left arrow key `release` method
      left.release = function() {
        //If the left arrow has been released, and the right arrow isn't down,
        //and the hero isn't moving vertically:
        //Stop the hero
        if (!right.isDown && hero.vy === 0) {
          hero.vx = 0;
        }
      };

      //Up
      up.press = function() {
        hero.vy = -3;
        hero.vx = 0;
        texture.setFrame(heroBack);
      };
      up.release = function() {
        if (!down.isDown && hero.vx === 0) {
          hero.vy = 0;

        }
      };

      //Right
      right.press = function() {
        hero.vx = 3;
        hero.vy = 0;
        texture.setFrame(heroRight);
      };
      right.release = function() {
        if (!left.isDown && hero.vy === 0) {
          hero.vx = 0;
        }
      };

      //Down
      down.press = function() {
        hero.vy = 3;
        hero.vx = 0;
        texture.setFrame(heroFront);
      };
      down.release = function() {
        if (!up.isDown && hero.vx === 0) {
          hero.vy = 0;
        }
      };

      // Set velocity
      hero.vx = 0;
      hero.vy = 0;

      // Set game state
      state = play;

      //Add the rocket to the stage
      stage.addChild(hero);

      //Render the stage
      renderer.render(stage);
    }

    function gameLoop() {

      //Loop this function at 60 frames per second
      requestAnimationFrame(gameLoop);

      //Update the current game state
      state();

      //Render the stage to see the animation
      renderer.render(stage);
    }


    function play() {

      //Handle collison
      contain(hero, {x: 28, y: 10, width: 488, height: 480});
      //Move the hero 1 pixel to the right each frame
      hero.x += hero.vx;
      hero.y += hero.vy;

      //check for a collision between the cat and the box
      if (hitTestRectangle(hero, goblin)) {

        //if there's a collision, change the message text
        //and tint the box red
        message.setText("hit!");
        hero.tint = 0xff3300;

      } else {

        //if there's no collision, reset the message
        //text and the box's color
        message.setText("No collision...");
        hero.tint = 0xffffff;

      }

    }

    function keyboard(keyCode) {
      var key = {};
      key.code = keyCode;
      key.isDown = false;
      key.isUp = true;
      key.press = undefined;
      key.release = undefined;
      //The `downHandler`
      key.downHandler = function(event) {
        if (event.keyCode === key.code) {
          if (key.isUp && key.press) key.press();
          key.isDown = true;
          key.isUp = false;
        }
        event.preventDefault();
      };

      //The `upHandler`
      key.upHandler = function(event) {
        if (event.keyCode === key.code) {
          if (key.isDown && key.release) key.release();
          key.isDown = false;
          key.isUp = true;
        }
        event.preventDefault();
      };

      //Attach event listeners
      window.addEventListener(
        "keydown", key.downHandler.bind(key), false
      );
      window.addEventListener(
        "keyup", key.upHandler.bind(key), false
      );
      return key;
    }

    function contain(sprite, container) {

      var collision = undefined;

      //Left
      if (sprite.x < container.x) {
        sprite.x = container.x;
        collision = "left";
      }

      //Top
      if (sprite.y < container.y) {
        sprite.y = container.y;
        collision = "top";
      }

      //Right
      if (sprite.x + sprite.width > container.width) {
        sprite.x = container.width - sprite.width;
        collision = "right";
      }

      //Bottom
      if (sprite.y + sprite.height > container.height) {
        sprite.y = container.height - sprite.height;
        collision = "bottom";
      }

      //Return the `collision` value
      return collision;
    }

    function hitTestRectangle(r1, r2) {
      //Define the variables we'll need to calculate
      var hit, combinedHalfWidths, combinedHalfHeights, vx, vy;
      //hit will determine whether there's a collision
      hit = false;
      //Find the center points of each sprite
      r1.centerX = r1.x + r1.width / 2;
      r1.centerY = r1.y + r1.height / 2;
      r2.centerX = r2.x + r2.width / 2;
      r2.centerY = r2.y + r2.height / 2;
      //Find the half-widths and half-heights of each sprite
      r1.halfWidth = r1.width / 2;
      r1.halfHeight = r1.height / 2;
      r2.halfWidth = r2.width / 2;
      r2.halfHeight = r2.height / 2;
      //Calculate the distance vector between the sprites
      vx = r1.centerX - r2.centerX;
      vy = r1.centerY - r2.centerY;
      //Figure out the combined half-widths and half-heights
      combinedHalfWidths = r1.halfWidth + r2.halfWidth;
      combinedHalfHeights = r1.halfHeight + r2.halfHeight;
      //Check for a collision on the x axis
      if (Math.abs(vx) < combinedHalfWidths) {
        //A collision might be occuring. Check for a collision on the y axis
        if (Math.abs(vy) < combinedHalfHeights) {
          //There's definitely a collision happening
          hit = true;
        } else {
          //There's no collision on the y axis
          hit = false;
        }
      } else {
        //There's no collision on the x axis
        hit = false;
      }
      //`hit` will be either `true` or `false`
      return hit;
    };


    //Start the game loop
    gameLoop();


    </script>
</body>